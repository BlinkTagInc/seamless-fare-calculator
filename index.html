<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <style>
    .bg-blue {
      background-color: #204285;
      border-bottom: 2px solid #ECB11E;
    }

    .btn-blue {
      color: #fff;
      background-color: #204285;
      border-color: #204285;
    }

    .btn-blue:hover {
      color: #fff;
      background-color: hsl(220, 58%, 40%);
      border-color: hsl(220, 58%, 40%);
    }

    .map {
      height: 400px;
    }

    .results {
      display: none;
    }

    .fare {
      font-size: 60px;
      font-weight: bold;
    }

    .fare.fare-range {
      font-size: 44px;
    }

    h2 {
      font-size: 1.25rem;
    }

    @media screen and (min-width: 768px) {
      h2 {
        font-size: 1.75rem;
      }
    }
  </style>

  <title>Fare Zone Calculator</title>
</head>

<body>
  <div class="container py-4 py-md-5">
    <div class="row">
      <div class="col-md-8 offset-md-2">
        <div class="card">
          <div class="card-body">
            <h2 class="card-title">Fare Zone Calculator</h2>
            <p>Enter a start and end location and see the current transit fare compared to a zone based fare.</p>
            <form id="zone-form">
              <div class="form-group row">
                <label for="start-address" class="col-sm-3 col-form-label">Start Address</label>
                <div class="col-sm-9">
                  <input type="text" class="form-control" id="start-address" placeholder="Haight & Ashbury" />
                </div>

              </div>
              <div class="form-group row">
                <label for="end-address" class="col-sm-3 col-form-label">End Address</label>
                <div class="col-sm-9">
                  <input type="text" class="form-control" id="end-address" placeholder="Walnut Creek" />
                </div>
              </div>
              <div class="form-group row">
                <label for="rider-class" class="col-sm-3 col-form-label">Rider Class</label>
                <div class="col-sm-9">
                  <select class="form-control" id="rider-class">
                    <option value="toddler">Toddler (0-5 years)</option>
                    <option value="child">Child (6-12 years)</option>
                    <option value="youth">Youth (13-17 years)</option>
                    <option value="adult" selected>Adult (18-64 years)</option>
                    <option value="senior">Senior (65+ years)</option>
                    <option value="disabled">Disabled</option>
                    <option value="low-income">Low-income</option>
                  </select>
                </div>
              </div>
              <button class="btn btn-blue btn-lg mt-4 btn-block" type="submit">Calculate</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="results" class="results mt-5">
      <h2 class="text-center"><span id="distance"></span> mile trip on <span id="agencies"></span></h2>
      <ul class="nav nav-pills justify-content-center mb-4" id="timeframe">
        <li class="nav-item">
          <a class="nav-link active" href="#" data-type="single">Single Trip</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-type="daily">Daily</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-type="weekly">Weekly</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-type="monthly">Monthly</a>
        </li>
      </ul>
      <div class="row">
        <div class="col-md-4 offset-md-2 mb-4">
          <div class="card h-100">
            <div class="card-body text-center">
              <h4>Current Fare</h4>
              <div class="fare" id="current-fare"></div>
              <div id="current-fare-notes"></div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-4">
          <div class="card h-100">
            <div class="card-body text-center">
              <h4>Zone-Based Fare</h4>
              <div class="fare" id="zone-fare"></div>
              <div id="zone-fare-details"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="map" class="map"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"
    integrity="sha256-7/yoZS3548fXSRXqc/xYzjsmuW3sFKzuvOCHd06Pmps=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jquery.scrollto@2.1.2/jquery.scrollTo.min.js" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@mapbox/polyline" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pluralize" crossorigin="anonymous"></script>

  <script>
    let map
    let autocomplete_origin
    let autocomplete_destination
    let directionsService
    let directionsRenderer
    let farezones
    let transitDirections
    let transitLegs
    let drivingDirections
    let renderMap = true

    fetch('/data/farezones.json')
      .then(result => result.json())
      .then(result => {
        result.features.forEach((feature, index) => {
          feature.properties.Name = `Zone ${index}`;
        })
        farezones = L.geoJson(result)
      })

    const currencyFormatter = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    })

    function arrayToSentence(a, b=a.pop()) {
      return a[0]?a.join(', ')+(a[1]?',':'')+' and '+b:b;
    }

    function initializeMapServices() {
      const bottom_left_lat = 37.700297
      const bottom_left_lon = -122.400741
      const top_right_lat = 38.058351
      const top_right_lon = -121.587719

      const defaultBounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(bottom_left_lat, bottom_left_lon),
        new google.maps.LatLng(top_right_lat, top_right_lon)
      )

      const mapStyles = [{
          "featureType": "administrative",
          "elementType": "all",
          "stylers": [{
            "saturation": "-100"
          }]
        },
        {
          "featureType": "administrative.province",
          "elementType": "all",
          "stylers": [{
            "visibility": "off"
          }]
        },
        {
          "featureType": "landscape",
          "elementType": "all",
          "stylers": [{
              "saturation": -100
            },
            {
              "lightness": 65
            },
            {
              "visibility": "on"
            }
          ]
        },
        {
          "featureType": "poi",
          "elementType": "all",
          "stylers": [{
              "saturation": -100
            },
            {
              "lightness": "50"
            },
            {
              "visibility": "simplified"
            }
          ]
        },
        {
          "featureType": "road",
          "elementType": "all",
          "stylers": [{
            "saturation": "-100"
          }]
        },
        {
          "featureType": "road.highway",
          "elementType": "all",
          "stylers": [{
            "visibility": "simplified"
          }]
        },
        {
          "featureType": "road.arterial",
          "elementType": "all",
          "stylers": [{
            "lightness": "30"
          }]
        },
        {
          "featureType": "road.local",
          "elementType": "all",
          "stylers": [{
            "lightness": "40"
          }]
        },
        {
          "featureType": "transit",
          "elementType": "all",
          "stylers": [{
              "saturation": -100
            },
            {
              "visibility": "simplified"
            }
          ]
        },
        {
          "featureType": "water",
          "elementType": "geometry",
          "stylers": [{
              "hue": "#ffff00"
            },
            {
              "lightness": -25
            },
            {
              "saturation": -97
            }
          ]
        },
        {
          "featureType": "water",
          "elementType": "labels",
          "stylers": [{
              "lightness": -25
            },
            {
              "saturation": -100
            }
          ]
        }
      ];

      const options = {
        bounds: defaultBounds,
        componentRestrictions: {
          country: 'us'
        }
      }

      autocomplete_origin = new google.maps.places.Autocomplete(document.getElementById('start-address'), options)
      autocomplete_destination = new google.maps.places.Autocomplete(document.getElementById('end-address'), options)

      autocomplete_origin.setFields(['geometry'])
      autocomplete_destination.setFields(['geometry'])

      directionsService = new google.maps.DirectionsService()

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 10,
        center: {
          lat: 37.7,
          lng: -122.3
        },
        styles: mapStyles
      })

      directionsRenderer = new google.maps.DirectionsRenderer({
        draggable: true,
        map
      })

      const transitLayer = new google.maps.TransitLayer()
      transitLayer.setMap(map)

      const kmlLayer = new google.maps.KmlLayer({
        url: `https://${location.host}/data/farezones.kml?cache=2020-08-17`,
        preserveViewport: true,
        suppressInfoWindows: true,
        map: map
      })

      kmlLayer.setMap(map)

      // map.data.loadGeoJson('/data/farezones.json')

      // map.data.setStyle({
      //   fillColor: '#cccccc',
      //   fillOpacity: 0.2,
      //   strokeWeight: 3,
      //   strokeColor: '#333333'
      // })
    }

    function metersToMiles(meters) {
      return meters / 1609.34
    }

    function getZoneFare(route) {
      const timeframe = $('#timeframe a.active').data('type');
      const decodedPath = polyline.decode(route.overview_polyline)
      const zones = {}

      decodedPath.forEach(function (point, idx) {
        // use first, last and every 4th point
        if (idx === 1 || idx % 4 === 0 || idx === (decodedPath.length - 1)) {
          var matchedZones = leafletPip.pointInLayer([point[1], point[0]], farezones, true)

          if (matchedZones && matchedZones.length && matchedZones[0].feature && matchedZones[0].feature
            .properties) {
            var zone = matchedZones[0].feature.properties
            zones[zone.Name] = true
          }
        }
      })

      const zoneCount = _.size(zones)

      const timeFrameMultipliers = {
        'single': 1,
        'daily': 3,
        'weekly': 9,
        'monthly': 36
      }

      return {
        zoneCount,
        fare: Math.max(2, zoneCount) * timeFrameMultipliers[timeframe]
      }
    }

    function fetchTransitStepDirections(startLocation, endLocation, time, resolve, reject) {
      directionsService.route({
          origin: startLocation,
          destination: endLocation,
          travelMode: 'TRANSIT',
          transitOptions: {
            departureTime: time
          }
        },
        (response, status) => {
          if (status !== 'OK') {
            return reject(new Error(status));
          }

          resolve(response);
        }
      )
    }

    function fetchTransitDirections(origin, destination, resolve, reject) {
      const nextMondayMorning = moment().startOf('isoWeek').add(1, 'week').day('monday').hour(8).minute(0).second(0)
        .toDate()
      directionsService.route({
          origin: origin.geometry.location,
          destination: destination.geometry.location,
          travelMode: 'TRANSIT',
          transitOptions: {
            departureTime: nextMondayMorning
          }
        },
        (response, status) => {
          if (status !== 'OK') {
            return reject(new Error(status));
          }

          resolve(response);
        }
      )
    }

    function fetchDrivingDirections(origin, destination, resolve, reject) {
      directionsService.route({
          origin: origin.geometry.location,
          destination: destination.geometry.location,
          travelMode: 'DRIVING',
        },
        (response, status) => {
          if (status !== 'OK') {
            return reject(new Error(status));
          }

          resolve(response);
        }
      )
    }

    function applyTimeframeCurrent(transitLegs) {
      const timeframe = $('#timeframe a.active').data('type');

      const agencies = {
        'AC Transit': {
          single: 1,
          daily: 2.2,
          weekly: 9,
          monthly: 36,
        },
        'Bay Area Rapid Transit': {
          single: 1,
          daily: 3,
          weekly: 9,
          monthly: 36
        },
        'Caltrain': {
          single: 1,
          daily: 2,
          weekly: 9,
          monthly: 27
        },
        'County Connection': {
          single: 1,
          daily: 1.9,
          weekly: 9,
          monthly: 30
        },
        'Dumbarton Express': {
          single: 1,
          daily: 2.2,
          weekly: 9,
          monthly: 36
        },
        'Fairfield and Suisun Transit': {
          single: 1,
          daily: 3,
          weekly: 9,
          monthly: 34
        },
        'Golden Gate Transit': {
          single: 1,
          daily: 3,
          weekly: 9,
          monthly: 36
        },
        'Marin Transit': {
          single: 1,
          daily: 2.8,
          weekly: 9,
          monthly: 22
        },
        'San Francisco Municipal Transportation Agency': {
          single: 1,
          daily: 7.6,
          weekly: 15.3,
          monthly: 27
        },
        'Petaluma Transit': {
          single: 1,
          daily: 3,
          weekly: 9,
          monthly: 20
        },
        'SamTrans': {
          single: 1,
          daily: 3,
          weekly: 9,
          monthly: 29
        },
        'Santa Rosa CityBus': {
          single: 1,
          daily: 2.7,
          weekly: 9,
          monthly: 33
          },
        'San Francisco Bay Ferry': {
          single: 1,
          daily: 3,
          weekly: 9,
          monthly: 36
        },
        'Sonoma Marin Area Rail Transit': {
          single: 1,
          daily: 3.1,
          weekly: 9,
          monthly: 27
        },
        'SolTrans': {
          single: 1,
          daily: 2.3,
          weekly: 9,
          monthly: 32
        },
        'Sonoma County Transit': {
          single: 1,
          daily: 3,
          weekly: 9,
          monthly: 28
        },
        'Tri Delta Transit': {
          single: 1,
          daily: 1.9,
          weekly: 9,
          monthly: 29
        },
        'Union City Transit': {
          single: 1,
          daily: 3,
          weekly: 9,
          monthly: 28
        },
        'Vacaville City Coach': {
          single: 1,
          daily: 3,
          weekly: 9,
          monthly: 24
        },
        'Napa': {
          single: 1,
          daily: 3,
          weekly: 9,
          monthly: 40
        },
        'VTA': {
          single: 1,
          daily: 3,
          weekly: 9,
          monthly: 35
        },
        'WestCat (Western Contra Costa)': {
          single: 1,
          daily: 2.1,
          weekly: 9,
          monthly: 23
        },
        'Livermore Amador Valley Transit Authority': {
          single: 1,
          daily: 1.9,
          weekly: 9,
          monthly: 30
        }
      }

      const defaultAgency =  {
        single: 1,
        daily: 3,
        weekly: 9,
        monthly: 36
      }

      return transitLegs.map(leg => {
        let multiplier = defaultAgency[timeframe]

        if (agencies[leg.agency]) {
          multiplier = agencies[leg.agency][timeframe]
        }

        return  {
          ...leg,
          fare: leg.fare * multiplier
        }
      })
    }

    function applyFareClassDiscountsCurrent(fare) {
      const fareClass = $('#rider-class').val()

      const fareClasses = {
        toddler: {
          minDiscount: 1,
          maxDiscount: 1
        },
        child: {
          minDiscount: 0,
          maxDiscount: 0.75
        },
        youth: {
          minDiscount: 0,
          maxDiscount: 0.75
        },
        adult: {
          minDiscount: 0,
          maxDiscount: 0
        },
        senior: {
          minDiscount: 0.5,
          maxDiscount: 0.75
        },
        disabled: {
          minDiscount: 0.5,
          maxDiscount: 0.75
        },
        'low-income': {
          minDiscount: 0,
          maxDiscount: 0.5
        }
      }

      const fareClassDiscount = fareClasses[fareClass]

      return {
        min: fare - fare * fareClassDiscount.minDiscount,
        max: fare - fare * fareClassDiscount.maxDiscount
      }
    }

    function applyFareClassDiscountsFuture(fare) {
      const fareClass = $('#rider-class').val()

      const fareClasses = {
        toddler: {
          discount: 1
        },
        child: {
          discount: 1
        },
        youth: {
          discount: 0.5
        },
        adult: {
          discount: 0
        },
        senior: {
          discount: 0.5
        },
        disabled: {
          discount: 0.5
        },
        'low-income': {
          discount: 0.5
        }
      }

      const discount = fareClasses[fareClass].discount
      return fare - fare * discount
    }

    function formatFareRange(fareRange) {
      if (fareRange.max === fareRange.min) {
        return currencyFormatter.format(fareRange.max)
      }

      return `${currencyFormatter.format(fareRange.max)} - ${currencyFormatter.format(fareRange.min)}`
    }

    async function renderResults() {
      if (!transitDirections || !drivingDirections) {
        return  alert('No directions found.')
      }

      const faresForTimeRange = applyTimeframeCurrent(transitLegs)
      const totalFare = _.sumBy(faresForTimeRange, 'fare')
      const agencyList = _.uniq(_.map(faresForTimeRange, 'agency'))
      const totalDistance = _.sumBy(faresForTimeRange, 'distance')
      const noFareAgencies = _.uniq(_.map(_.filter(faresForTimeRange, leg => leg.noFareAgency), 'agency'))

      const fareRange = applyFareClassDiscountsCurrent(totalFare)
      if (noFareAgencies.length > 0) {
        $('#current-fare').text(formatFareRange(fareRange)).append('<sup>†</sup>').toggleClass('fare-range', fareRange.min !== fareRange.max)
        $('#current-fare-notes').html([
          '<sup>†</sup>',
          $('<span>').text(`Incomplete fare information from ${_.uniq(noFareAgencies).join(' and ')}.`)
        ]);
      } else {
        $('#current-fare').text(formatFareRange(fareRange)).toggleClass('fare-range', fareRange.min !== fareRange.max)
        $('#current-fare-notes').text(pluralize('agency', agencyList.length, true))
      }

      const zoneFare = getZoneFare(drivingDirections.routes[0])

      const fare = applyFareClassDiscountsFuture(zoneFare.fare)
      $('#zone-fare').text(currencyFormatter.format(fare))
      $('#zone-fare-details').text(pluralize('zone', zoneFare.zoneCount, true))

      $('#agencies').text(arrayToSentence(agencyList))
      $('#distance').text(Math.round(metersToMiles(totalDistance) * 10) / 10)

      $('#results').show()
      $('body').scrollTo('#results', 1000)

      if (renderMap === true) {
        directionsRenderer.setDirections(transitDirections)
        renderMap = false
      }
    }

    $('#zone-form').submit(event => {
      event.preventDefault()

      const origin = autocomplete_origin.getPlace()
      if (!origin || !origin.geometry) {
        return alert('Please enter a start location, like "San Francisco" or "123 Walnut Street, Walnut Creek"')
      }

      const destination = autocomplete_destination.getPlace()
      if (!destination || !destination.geometry) {
        return alert('Please enter an end location, like "San Francisco" or "123 Walnut Street, Walnut Creek"')
      }

      Promise.all([
          new Promise((resolve, reject) => {
            fetchTransitDirections(origin, destination, resolve, reject)
          }),
          new Promise((resolve, reject) => {
            fetchDrivingDirections(origin, destination, resolve, reject)
          }),
        ])
        .then(async ([result1, result2]) => {
          transitDirections = result1
          drivingDirections = result2
          renderMap = true
          transitLegs = []

          const agencyFareInfo = {
            'AC Transit': {
              value: 2.5
            },
            'Dumbarton Express Consortium': {
              value: 6
            }
          }

          await Promise.all(transitDirections.routes[0].legs.map(async leg => {
            return Promise.all(leg.steps.map(async step => {
              if (step.travel_mode !== 'TRANSIT') {
                return;
              }

              const stepDirections = await new Promise((resolve, reject) => {
                fetchTransitStepDirections(step.start_location, step.end_location, step.transit
                  .departure_time.value, resolve, reject);
              });

              if (stepDirections && stepDirections.routes && stepDirections.routes.length > 0) {
                const leg = {
                  distance: step.distance.value
                }

                stepDirections.routes[0].legs.forEach(routeLeg => routeLeg.steps.forEach(step => {
                  if (step.transit) {
                    step.transit.line.agencies.forEach(agency => {
                      leg.agency = agency.name;
                    });
                  }
                }));

                if (agencyFareInfo[leg.agency]) {
                  leg.fare = agencyFareInfo[leg.agency].value;
                  leg.noFareAgency = true
                } else if (stepDirections.routes[0].fare) {
                  leg.fare = stepDirections.routes[0].fare.value;
                } else {
                  leg.fare = 0;
                }

                transitLegs.push(leg);
              }
            }));
          }));

          renderResults();
        })
        .catch(error => {
          console.error(error)
          $('#results').hide()
          return alert('Unable to compare trip')
        })

      $('#timeframe a').on('click', function (e) {
        e.preventDefault()
        $(this).tab('show')

        renderResults()
      })
    })
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKpeuYy5IXMrsQpmwVMpHP_6ymFkqnFbE&libraries=places&callback=initializeMapServices"
    async defer></script>
</body>

</html>
