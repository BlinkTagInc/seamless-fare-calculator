<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      height:100%;
      width:100%;
      font-family: 'Source Sans Pro', sans-serif;
    }

    a {
      color: #1C4587;
    }

    a:hover {
      color: hsl(220, 58%, 40%);
    }

    .bg-blue {
      background-color: #1C4587;
      border-bottom: 2px solid #ECB11E;
    }

    .btn-blue {
      color: #fff;
      background-color: #1C4587;
      border-color: #1C4587;
    }

    .btn-blue:hover {
      color: #fff;
      background-color: hsl(220, 58%, 40%);
      border-color: hsl(220, 58%, 40%);
    }

    .nav-pills .nav-link.active, .nav-pills .show>.nav-link {
      color: #fff;
      background-color: #1C4587;
      border-color: #1C4587;
    }

    .nav-pills .nav-link.active:hover, .nav-pills .show>.nav-link:hover  {
      color: #fff;
      background-color: hsl(220, 58%, 40%);
      border-color: hsl(220, 58%, 40%);
    }

    .panel-title {
      font-size: 23px;
      color: #FFFFFF;
      padding: 8px 15px;
      background-color: #1C4587;
      font-weight: bold;
    }

    .map {
      width: 100%;
      height: 300px;
    }

    .results {
      display: none;
    }

    .fare {
      font-size: 42px;
      font-weight: bold;
      line-height: 1;
      padding: 6px 0;
    }

    .fare.fare-range {
      font-size: 32px;
    }

    .edit-button {
      position: absolute;
      top: 5px;
      right: 8px;
      color: #8a8a67;
    }

    h2 {
      font-size: 1.25rem;
    }

    h3 {
      font-size: 1.25rem;
    }

    h4 {
      font-size: 1.3rem;
    }

    .zone-form .col-form-label {
      width: 100px;
    }

    .reset-button {
      display: none;
    }

    .panel {
      flex-shrink: 0;
      position: relative;
      overflow-y: scroll  ;
    }

    .panel-content {
      padding: 10px 15px;
    }

    .footer-credits {
      font-size: 12px;
      line-height: 1;
    }

    .note {
      font-size: 12px;
      background-color: yellow;
      line-height: 1;
      padding: 5px;
      text-align: left;
    }

    .notes {
      font-size: 12px;
    }

    .formatted-address {
      line-height: 1;
      font-size: 13px;
    }

    @media screen and (min-width: 992px) {
      .panel {
        width: 500px;
      }

      .map {
        width: 100%;
        height: 100%;
      }

      h2 {
        font-size: 1.75rem;
      }

      h3 {
        font-size: 1.25rem;
      }
    }
  </style>

  <title>Bay Area Integrated Transit Fare Vision Map</title>

  <script src="https://kit.fontawesome.com/c640b06c81.js" crossorigin="anonymous"></script>
</head>

<body>
  <div class="d-block d-lg-flex h-100">
    <div class="panel d-flex flex-column justify-content-between">
      <div>
        <h1 class="panel-title mb-0">Bay Area Integrated Transit Fare Vision Map</h1>
        <div class="panel-content pt-1">
          <div class="font-italic mb-3" style="font-size: 13px;">Created by <a href="https://www.seamlessbayarea.org/">Seamless Bay Area</a></div>
          <form id="zone-form" class="zone-form">
            <p>Compare the cost of a transit trip today with <a href="https://www.seamlessbayarea.org/integrated-fare-vision">Seamless Bay Areaâ€™s vision of an integrated</a>, zone-based fare system.</p>
            <p>Enter a start and end location:</p>
            <div class="form-group d-flex">
              <label for="start-address" class="col-form-label mr-3 flex-shrink-0">Start Address</label>
              <input type="text" class="form-control" id="start-address" placeholder="Haight & Ashbury" />
            </div>
            <div class="form-group d-flex">
              <label for="end-address" class="col-form-label mr-3 flex-shrink-0">End Address</label>
              <input type="text" class="form-control" id="end-address" placeholder="Walnut Creek" />
            </div>
            <div class="form-group d-flex">
              <label for="rider-class" class="col-form-label mr-3 flex-shrink-0">Rider Class</label>
              <select class="form-control" id="rider-class">
                <option value="toddler">Toddler (0-5 years)</option>
                <option value="child">Child (6-12 years)</option>
                <option value="youth">Youth (13-17 years)</option>
                <option value="student">Student</option>
                <option value="adult" selected>Adult (18-64 years)</option>
                <option value="senior">Senior (65+ years)</option>
                <option value="disabled">Disabled</option>
                <option value="low-income">Low-income</option>
              </select>
            </div>
            <button class="btn btn-blue btn-lg mt-4 btn-block" type="submit">Calculate</button>
          </form>

          <div id="results" class="results">
            <h3 class="mb-0"><span id="distance"></span> mile trip on <span id="agencies"></span></h3>
            <div class="mb-1">Rider Class: <span id="rider-info" ></span></div>
            <div class="d-md-flex mb-3">
              <div class="d-flex mb-1 mb-md-0 align-items-center" style="flex: 1;">
                <img alt="" src="data:image/svg+xml,%3Csvg%20version%3D%221.1%22%20width%3D%2227px%22%20height%3D%2243px%22%20viewBox%3D%220%200%2027%2043%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%3E%0A%3Cdefs%3E%0A%3Cpath%20id%3D%22a%22%20d%3D%22m12.5%200c-6.9039%200-12.5%205.5961-12.5%2012.5%200%201.8859%200.54297%203.7461%201.4414%205.4617%203.425%206.6156%2010.216%2013.566%2010.216%2022.195%200%200.46562%200.37734%200.84297%200.84297%200.84297s0.84297-0.37734%200.84297-0.84297c0-8.6289%206.7906-15.58%2010.216-22.195%200.89844-1.7156%201.4414-3.5758%201.4414-5.4617%200-6.9039-5.5961-12.5-12.5-12.5z%22%2F%3E%0A%3C%2Fdefs%3E%0A%3Cg%20fill%3D%22none%22%20fill-rule%3D%22evenodd%22%3E%0A%3Cg%20transform%3D%22translate(1%201)%22%3E%0A%3Cuse%20fill%3D%22%23EA4335%22%20fill-rule%3D%22evenodd%22%20xlink%3Ahref%3D%22%23a%22%2F%3E%0A%3Cpath%20d%3D%22m12.5-0.5c7.18%200%2013%205.82%2013%2013%200%201.8995-0.52398%203.8328-1.4974%205.6916-0.91575%201.7688-1.0177%201.9307-4.169%206.7789-4.2579%206.5508-5.9907%2010.447-5.9907%2015.187%200%200.74177-0.6012%201.343-1.343%201.343s-1.343-0.6012-1.343-1.343c0-4.7396-1.7327-8.6358-5.9907-15.187-3.1512-4.8482-3.2532-5.01-4.1679-6.7768-0.97449-1.8608-1.4985-3.7942-1.4985-5.6937%200-7.18%205.82-13%2013-13z%22%20stroke%3D%22%23fff%22%2F%3E%0A%3C%2Fg%3E%0A%3Ctext%20text-anchor%3D%22middle%22%20dy%3D%220.3em%22%20x%3D%2214%22%20y%3D%2215%22%20font-family%3D%22Roboto%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2216px%22%20fill%3D%22%23FFF%22%3EA%3C%2Ftext%3E%0A%3C%2Fg%3E%0A%3C%2Fsvg%3E%0A" draggable="false" usemap="#gmimap0" style="width: 13px; height: 21px;">
                <div id="origin" class="formatted-address ml-1"></div>
              </div>
              <div class="d-flex align-items-center" style="flex: 1">
                <img alt="" src="data:image/svg+xml,%3Csvg%20version%3D%221.1%22%20width%3D%2227px%22%20height%3D%2243px%22%20viewBox%3D%220%200%2027%2043%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%3E%0A%3Cdefs%3E%0A%3Cpath%20id%3D%22a%22%20d%3D%22m12.5%200c-6.9039%200-12.5%205.5961-12.5%2012.5%200%201.8859%200.54297%203.7461%201.4414%205.4617%203.425%206.6156%2010.216%2013.566%2010.216%2022.195%200%200.46562%200.37734%200.84297%200.84297%200.84297s0.84297-0.37734%200.84297-0.84297c0-8.6289%206.7906-15.58%2010.216-22.195%200.89844-1.7156%201.4414-3.5758%201.4414-5.4617%200-6.9039-5.5961-12.5-12.5-12.5z%22%2F%3E%0A%3C%2Fdefs%3E%0A%3Cg%20fill%3D%22none%22%20fill-rule%3D%22evenodd%22%3E%0A%3Cg%20transform%3D%22translate(1%201)%22%3E%0A%3Cuse%20fill%3D%22%23EA4335%22%20fill-rule%3D%22evenodd%22%20xlink%3Ahref%3D%22%23a%22%2F%3E%0A%3Cpath%20d%3D%22m12.5-0.5c7.18%200%2013%205.82%2013%2013%200%201.8995-0.52398%203.8328-1.4974%205.6916-0.91575%201.7688-1.0177%201.9307-4.169%206.7789-4.2579%206.5508-5.9907%2010.447-5.9907%2015.187%200%200.74177-0.6012%201.343-1.343%201.343s-1.343-0.6012-1.343-1.343c0-4.7396-1.7327-8.6358-5.9907-15.187-3.1512-4.8482-3.2532-5.01-4.1679-6.7768-0.97449-1.8608-1.4985-3.7942-1.4985-5.6937%200-7.18%205.82-13%2013-13z%22%20stroke%3D%22%23fff%22%2F%3E%0A%3C%2Fg%3E%0A%3Ctext%20text-anchor%3D%22middle%22%20dy%3D%220.3em%22%20x%3D%2214%22%20y%3D%2215%22%20font-family%3D%22Roboto%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2216px%22%20fill%3D%22%23FFF%22%3EB%3C%2Ftext%3E%0A%3C%2Fg%3E%0A%3C%2Fsvg%3E%0A" draggable="false" usemap="#gmimap1" style="width: 13px; height: 21px;">
                <div id="destination" class="formatted-address ml-1"></div>
              </div>
            </div>
            <ul class="nav nav-pills justify-content-center mb-4" id="timeframe">
              <li class="nav-item">
                <a class="nav-link active" href="#" data-type="single">Single Trip</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" data-type="daily">Daily</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" data-type="monthly">Monthly</a>
              </li>
            </ul>

            <div class="row">
              <div class="col-md-6 mb-2">
                <div class="card h-100">
                  <div class="card-body text-center">
                    <a class="edit-button" href="#" id="edit-fare"><i class="fas fa-pencil-alt" title="Edit Fare"></i></a>
                    <h4>Current Fare</h4>
                    <div class="fare" id="current-fare"></div>
                    <div id="current-fare-notes"></div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-2">
                <div class="card h-100">
                  <div class="card-body text-center">
                    <h4>Zone-Based Fare</h4>
                    <div class="fare" id="zone-fare"></div>
                    <div id="zone-fare-notes"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 offset-md-6" id="single-fare-table">
                <img src="/images/single-fare-table.png" class="w-100" />
              </div>
              <div class="col-md-6 offset-md-6" id="daily-cap-table">
                <img src="/images/daily-cap-table.png" class="w-100" />
              </div>
              <div class="col-md-6 offset-md-6" id="monthly-cap-table">
                <img src="/images/monthly-cap-table.png" class="w-100" />
              </div>
            </div>

            <div class="notes my-2" id="overall-notes"></div>
          </div>
          <a href="#" class="btn btn-sm btn-secondary btn-block reset-button" id="reset-button"><i class="far fa-redo-alt"></i> Calculate Another Trip</a>
        </div>
      </div>

      <div class="mt-3 d-none d-md-block">
        <div class="panel-content">
          <div class="mb-2">Have questions about this map? See our <a href="https://www.seamlessbayarea.org/integrated-fare-vision">FAQ</a>.</div>
          <div class="d-flex justify-content-between align-items-end">
            <a href="https://www.seamlessbayarea.org/" class="d-block flex-shrink-1"><img src="/images/logo.png" alt="Seamless Bay Area" width="150" height="42" /></a>
            <div class="footer-credits ml-3 text-right">Developed by <a href="https://blinktag.com" target="_blank">BlinkTag Inc</a></div>
          </div>
        </div>
      </div>
    </div>
    <div id="map" class="map mt-3 mt-md-0"></div>

    <div class="p-3 d-md-none">
      <div class="mb-3" style="font-size: 13px;">Have questions about this map? See our <a href="https://www.seamlessbayarea.org/integrated-fare-vision">FAQ</a>.</div>
      <div class="d-flex justify-content-between align-items-end">
        <a href="https://www.seamlessbayarea.org/" class="d-block flex-shrink-1"><img src="/images/logo.png" alt="Seamless Bay Area" width="150" height="42" /></a>
        <div class="footer-credits ml-3 text-right">Developed by <a href="https://blinktag.com" target="_blank">BlinkTag Inc</a></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"
    integrity="sha256-7/yoZS3548fXSRXqc/xYzjsmuW3sFKzuvOCHd06Pmps=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous">
  </script>
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@mapbox/polyline" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pluralize" crossorigin="anonymous"></script>

  <script>
    let map
    let autocomplete_origin
    let autocomplete_destination
    let directionsService
    let directionsRenderer
    let farezones
    let transitDirections
    let transitLegs
    let drivingDirections
    let renderMap = true
    let origin
    let destination
    let editedFare

    fetch('/data/farezones.json')
      .then(result => result.json())
      .then(result => {
        result.features.forEach((feature, index) => {
          feature.properties.Name = `Zone ${index}`;
        })
        farezones = L.geoJson(result)
      })

    const currencyFormatter = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    })

    function arrayToSentence(arr) {
      return arr.join(', ').replace(/,\s([^,]+)$/, ' and $1')
    }

    function initializeMapServices() {
      const bottom_left_lat = 37.700297
      const bottom_left_lon = -122.400741
      const top_right_lat = 38.058351
      const top_right_lon = -121.587719

      const defaultBounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(bottom_left_lat, bottom_left_lon),
        new google.maps.LatLng(top_right_lat, top_right_lon)
      )

      const mapStyles = [{
          "featureType": "administrative",
          "elementType": "all",
          "stylers": [{
            "saturation": "-100"
          }]
        },
        {
          "featureType": "administrative.province",
          "elementType": "all",
          "stylers": [{
            "visibility": "off"
          }]
        },
        {
          "featureType": "landscape",
          "elementType": "all",
          "stylers": [{
              "saturation": -100
            },
            {
              "lightness": 65
            },
            {
              "visibility": "on"
            }
          ]
        },
        {
          "featureType": "poi",
          "elementType": "all",
          "stylers": [{
              "saturation": -100
            },
            {
              "lightness": "50"
            },
            {
              "visibility": "simplified"
            }
          ]
        },
        {
          "featureType": "road",
          "elementType": "all",
          "stylers": [{
            "saturation": "-100"
          }]
        },
        {
          "featureType": "road.highway",
          "elementType": "all",
          "stylers": [{
            "visibility": "simplified"
          }]
        },
        {
          "featureType": "road.arterial",
          "elementType": "all",
          "stylers": [{
            "lightness": "30"
          }]
        },
        {
          "featureType": "road.local",
          "elementType": "all",
          "stylers": [{
            "lightness": "40"
          }]
        },
        {
          "featureType": "transit",
          "elementType": "all",
          "stylers": [{
              "saturation": -100
            },
            {
              "visibility": "simplified"
            }
          ]
        },
        {
          "featureType": "water",
          "elementType": "geometry",
          "stylers": [{
              "hue": "#ffff00"
            },
            {
              "lightness": -25
            },
            {
              "saturation": -97
            }
          ]
        },
        {
          "featureType": "water",
          "elementType": "labels",
          "stylers": [{
              "lightness": -25
            },
            {
              "saturation": -100
            }
          ]
        }
      ];

      const options = {
        bounds: defaultBounds,
        componentRestrictions: {
          country: 'us'
        }
      }

      autocomplete_origin = new google.maps.places.Autocomplete(document.getElementById('start-address'), options)
      autocomplete_destination = new google.maps.places.Autocomplete(document.getElementById('end-address'), options)

      autocomplete_origin.setFields(['formatted_address', 'geometry'])
      autocomplete_destination.setFields(['formatted_address', 'geometry'])

      directionsService = new google.maps.DirectionsService()

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 10,
        center: {
          lat: 37.7,
          lng: -122.3
        },
        styles: mapStyles
      })

      directionsRenderer = new google.maps.DirectionsRenderer({
        draggable: true,
        map
      })

      const transitLayer = new google.maps.TransitLayer()
      transitLayer.setMap(map)

      const kmlLayer = new google.maps.KmlLayer({
        url: `https://${location.host}/data/farezones.kml?cache=2020-08-17`,
        preserveViewport: true,
        suppressInfoWindows: true,
        map: map
      })

      kmlLayer.setMap(map)

      // map.data.loadGeoJson('/data/farezones.json')

      // map.data.setStyle({
      //   fillColor: '#cccccc',
      //   fillOpacity: 0.2,
      //   strokeWeight: 3,
      //   strokeColor: '#333333'
      // })
    }

    function metersToMiles(meters) {
      return meters / 1609.34
    }

    function getZoneFare(route) {
      const timeframe = $('#timeframe a.active').data('type');
      const decodedPath = polyline.decode(route.overview_polyline)
      const zones = {}

      decodedPath.forEach(function (point, idx) {
        // use first, last and every 4th point
        if (idx === 1 || idx % 4 === 0 || idx === (decodedPath.length - 1)) {
          var matchedZones = leafletPip.pointInLayer([point[1], point[0]], farezones, true)

          if (matchedZones && matchedZones.length && matchedZones[0].feature && matchedZones[0].feature
            .properties) {
            var zone = matchedZones[0].feature.properties
            zones[zone.Name] = true
          }
        }
      })

      const zoneCount = _.size(zones)

      const timeFrameMultipliers = {
        'single': 1,
        'daily': 2.5,
        'monthly': 36
      }

      const minimumFare = 2.2

      return {
        zoneCount,
        fare: Math.max(minimumFare, (zoneCount - 2) + minimumFare) * timeFrameMultipliers[timeframe]
      }
    }

    function fetchTransitStepDirections(startLocation, endLocation, time, resolve, reject) {
      directionsService.route({
          origin: startLocation,
          destination: endLocation,
          travelMode: 'TRANSIT',
          transitOptions: {
            departureTime: time
          }
        },
        (response, status) => {
          if (status !== 'OK') {
            return reject(new Error(status));
          }

          resolve(response);
        }
      )
    }

    function fetchTransitDirections(resolve, reject) {
      const nextMondayMorning = moment().startOf('isoWeek').add(1, 'week').day('monday').hour(8).minute(0).second(0)
        .toDate()
      directionsService.route({
          origin: origin.geometry.location,
          destination: destination.geometry.location,
          travelMode: 'TRANSIT',
          transitOptions: {
            departureTime: nextMondayMorning
          }
        },
        (response, status) => {
          if (status !== 'OK') {
            return reject(new Error(status));
          }

          resolve(response);
        }
      )
    }

    function fetchDrivingDirections(resolve, reject) {
      directionsService.route({
          origin: origin.geometry.location,
          destination: destination.geometry.location,
          travelMode: 'DRIVING',
        },
        (response, status) => {
          if (status !== 'OK') {
            return reject(new Error(status));
          }

          resolve(response);
        }
      )
    }

    function applyTimeframeCurrent(transitLegs) {
      const timeframe = $('#timeframe a.active').data('type');

      const agencies = {
        'AC Transit': {
          single: 1,
          daily: 2.2,
          monthly: 36,
        },
        'Bay Area Rapid Transit': {
          single: 1,
          daily: 3,
          monthly: 36
        },
        'Caltrain': {
          single: 1,
          daily: 2,
          monthly: 27
        },
        'County Connection': {
          single: 1,
          daily: 1.9,
          monthly: 30
        },
        'Dumbarton Express': {
          single: 1,
          daily: 2.2,
          monthly: 36
        },
        'Fairfield and Suisun Transit': {
          single: 1,
          daily: 3,
          monthly: 34
        },
        'Golden Gate Transit': {
          single: 1,
          daily: 3,
          monthly: 36
        },
        'Marin Transit': {
          single: 1,
          daily: 2.8,
          monthly: 22
        },
        'San Francisco Municipal Transportation Agency': {
          single: 1,
          daily: 7.6,
          monthly: 27
        },
        'Petaluma Transit': {
          single: 1,
          daily: 3,
          monthly: 20
        },
        'SamTrans': {
          single: 1,
          daily: 3,
          monthly: 29
        },
        'Santa Rosa CityBus': {
          single: 1,
          daily: 2.7,
          monthly: 33
          },
        'San Francisco Bay Ferry': {
          single: 1,
          daily: 3,
          monthly: 36
        },
        'Sonoma Marin Area Rail Transit': {
          single: 1,
          daily: 3.1,
          monthly: 27
        },
        'SolTrans': {
          single: 1,
          daily: 2.3,
          monthly: 32
        },
        'Sonoma County Transit': {
          single: 1,
          daily: 3,
          monthly: 28
        },
        'Tri Delta Transit': {
          single: 1,
          daily: 1.9,
          monthly: 29
        },
        'Union City Transit': {
          single: 1,
          daily: 3,
          monthly: 28
        },
        'Vacaville City Coach': {
          single: 1,
          daily: 3,
          monthly: 24
        },
        'Napa': {
          single: 1,
          daily: 3,
          monthly: 40
        },
        'VTA': {
          single: 1,
          daily: 3,
          monthly: 35
        },
        'WestCat (Western Contra Costa)': {
          single: 1,
          daily: 2.1,
          monthly: 23
        },
        'Livermore Amador Valley Transit Authority': {
          single: 1,
          daily: 1.9,
          monthly: 30
        }
      }

      const defaultAgency =  {
        single: 1,
        daily: 3,
        monthly: 36
      }

      return transitLegs.map(leg => {
        let multiplier = defaultAgency[timeframe]

        if (agencies[leg.agency]) {
          multiplier = agencies[leg.agency][timeframe]
        }

        return  {
          ...leg,
          fare: leg.fare * multiplier
        }
      })
    }

    function applyFareClassDiscountsCurrent(fare) {
      const fareClass = $('#rider-class').val()

      const fareClasses = {
        toddler: {
          minDiscount: 1,
          maxDiscount: 1
        },
        child: {
          minDiscount: 0,
          maxDiscount: 0.75
        },
        youth: {
          minDiscount: 0,
          maxDiscount: 0.75
        },
        student: {
          minDiscount: 0,
          maxDiscount: 0
        },
        adult: {
          minDiscount: 0,
          maxDiscount: 0
        },
        senior: {
          minDiscount: 0.5,
          maxDiscount: 0.75
        },
        disabled: {
          minDiscount: 0.5,
          maxDiscount: 0.75
        },
        'low-income': {
          minDiscount: 0,
          maxDiscount: 0.5
        }
      }

      const fareClassDiscount = fareClasses[fareClass]

      return {
        min: fare - fare * fareClassDiscount.minDiscount,
        max: fare - fare * fareClassDiscount.maxDiscount
      }
    }

    function applyFareClassDiscountsFuture(fare) {
      const fareClass = $('#rider-class').val()

      const fareClasses = {
        toddler: {
          discount: 1
        },
        child: {
          discount: 1
        },
        youth: {
          discount: 0.5
        },
        student: {
          discount: 0.5
        },
        adult: {
          discount: 0
        },
        senior: {
          discount: 0.5
        },
        disabled: {
          discount: 0.5
        },
        'low-income': {
          discount: 0.5
        }
      }

      const discount = fareClasses[fareClass].discount
      return fare - fare * discount
    }

    function formatFareRange(fareRange) {
      if (fareRange.max === fareRange.min) {
        return currencyFormatter.format(fareRange.max)
      }

      return `${currencyFormatter.format(fareRange.max)} - ${currencyFormatter.format(fareRange.min)}`
    }

    function sumFares(faresForTimeRange) {
      return _.sumBy(_.uniqBy(faresForTimeRange, 'agency'), 'fare')
    }

    async function renderResults() {
      if (!transitDirections || !drivingDirections) {
        return  alert('No directions found.')
      }

      const timeframe = $('#timeframe a.active').data('type');
      const fareClass = $('#rider-class').val()
      const currentFareNotes = []
      const currentFareNotesAsterisks = []
      const zoneFareNotes = []
      const overallNotes = []

      if (editedFare) {
        transitLegs = [
          {
            fare: editedFare
          }
        ]

        currentFareNotes.push(
          $('<div>').addClass('note').text('Fare manually edited.')
        )
      }

      const faresForTimeRange = applyTimeframeCurrent(transitLegs)
      const totalFare = sumFares(faresForTimeRange)
      const agencyList = _.uniq(_.map(faresForTimeRange, 'agency'))
      const totalDistance = _.sumBy(faresForTimeRange, 'distance')
      const noFareAgencies = _.uniq(_.map(_.filter(faresForTimeRange, leg => leg.noFareAgency), 'agency'))
      const fareRange = applyFareClassDiscountsCurrent(totalFare)
      const zoneFare = getZoneFare(drivingDirections.routes[0])

      currentFareNotes.push($('<div>').text(pluralize('agency', agencyList.length, true)))

      if (noFareAgencies.length > 0) {
        currentFareNotesAsterisks.push('â€ ')
        currentFareNotes.push(
          $('<div>').addClass('note').html([
            '<sup>â€ </sup>',
            $('<span>').text(`Incomplete fare information from ${_.uniq(noFareAgencies).join(' and ')}.`)
          ])
        )
      }

      if (fareClass === 'student') {
        currentFareNotesAsterisks.push('â€¡')
        currentFareNotes.push(
          $('<div>').addClass('note').html([
            '<sup>â€¡</sup>',
            $('<span>').text('Student discounts vary by educational institution and are impossible to predict. Adult fare shown.')
          ])
        )
      }

      currentFareNotes.push(
        $('<div>').addClass('note').html(
          'â€œCurrent fareâ€œ is the cash fare retrieved from Google Transit Directions. <a href="https://www.seamlessbayarea.org/integrated-fare-vision">Read more Â»</a>.'
        )
      ) 

      zoneFareNotes.push(
        $('<div>').text(pluralize('zone', zoneFare.zoneCount, true))
      )

      if (timeframe === 'daily') {
        overallNotes.push(
          $('<div>').html('Assumes 3 trips / day; includes cost of any regular passes currently provided by agencies for daily travel.')
        )
      }

      if (timeframe === 'monthly') {
        overallNotes.push(
          $('<div>').html('Assumes 36 trips / month; includes cost of any regular passes currently provided by agencies for daily travel.')
        )
      }

      $('#current-fare-notes').html(currentFareNotes)
      $('#origin').html(origin.formatted_address)
      $('#destination').html(destination.formatted_address)

      $('#current-fare')
        .text(formatFareRange(fareRange))
        .toggleClass('fare-range', fareRange.min !== fareRange.max)
        .append(currentFareNotesAsterisks.map(asterisk => $('<sup>').text(asterisk)))

      const fare = applyFareClassDiscountsFuture(zoneFare.fare)
      $('#zone-fare').text(currencyFormatter.format(fare))
      $('#zone-fare-notes').html(zoneFareNotes)

      $('#overall-notes').html(overallNotes)

      $('#agencies').text(arrayToSentence(agencyList))
      $('#distance').text(Math.round(metersToMiles(totalDistance) * 10) / 10)
      $('#rider-info').text($('#rider-class option:selected').text())

      if (timeframe === 'single') {
        $('#single-fare-table')
          .show()
          .siblings().hide();
      } else if (timeframe === 'daily') {
        $('#daily-cap-table')
          .show()
          .siblings().hide();
      } else if (timeframe === 'monthly') {
        $('#monthly-cap-table')
          .show()
          .siblings().hide();
      }

      $('#zone-form').slideUp('fast')
      $('#results').slideDown('fast')
      $('#reset-button').fadeIn('fast')

      if (renderMap === true) {
        directionsRenderer.setMap(map)
        directionsRenderer.setDirections(transitDirections)
        renderMap = false
      }
    }

    $('#zone-form').submit(event => {
      event.preventDefault()

      origin = autocomplete_origin.getPlace()
      if (!origin || !origin.geometry) {
        return alert('Please enter a start location, like "San Francisco" or "123 Walnut Street, Walnut Creek"')
      }

      destination = autocomplete_destination.getPlace()
      if (!destination || !destination.geometry) {
        return alert('Please enter an end location, like "San Francisco" or "123 Walnut Street, Walnut Creek"')
      }

      Promise.all([
          new Promise((resolve, reject) => {
            fetchTransitDirections(resolve, reject)
          }),
          new Promise((resolve, reject) => {
            fetchDrivingDirections(resolve, reject)
          }),
        ])
        .then(async ([result1, result2]) => {
          transitDirections = result1
          drivingDirections = result2
          renderMap = true
          transitLegs = []

          const agencyFareInfo = {
            'AC Transit': {
              value: 2.5
            },
            'Dumbarton Express Consortium': {
              value: 6
            }
          }

          await Promise.all(transitDirections.routes[0].legs.map(async leg => {
            return Promise.all(leg.steps.map(async step => {
              if (step.travel_mode !== 'TRANSIT') {
                return;
              }

              const stepDirections = await new Promise((resolve, reject) => {
                fetchTransitStepDirections(step.start_location, step.end_location, step.transit
                  .departure_time.value, resolve, reject);
              });

              if (stepDirections && stepDirections.routes && stepDirections.routes.length > 0) {
                const leg = {
                  distance: step.distance.value
                }

                stepDirections.routes[0].legs.forEach(routeLeg => routeLeg.steps.forEach(step => {
                  if (step.transit) {
                    step.transit.line.agencies.forEach(agency => {
                      leg.agency = agency.name;
                    });
                  }
                }));

                if (agencyFareInfo[leg.agency]) {
                  leg.fare = agencyFareInfo[leg.agency].value;
                  leg.noFareAgency = true
                } else if (stepDirections.routes[0].fare) {
                  leg.fare = stepDirections.routes[0].fare.value;
                } else {
                  leg.fare = 0;
                }

                transitLegs.push(leg);
              }
            }));
          }));

          renderResults();
        })
        .catch(error => {
          console.error(error)
          $('#results').hide()
          return alert('Unable to compare trip')
        })

      $('#reset-button').click(event => {
        event.preventDefault()

        $('#zone-form').slideDown('fast')
        $('#results').slideUp('fast')
        $('#reset-button').fadeOut('fast')

        autocomplete_origin.set('place', null);
        autocomplete_destination.set('place', null)

        directionsRenderer.setMap(null)

        $('#start-address').val('')
        $('#end-address').val('')
        $('#rider-class').val('adult')
        $('#timeframe a').each((index, el) => {
          if ($(el).data('type') === 'single') {
            $(el).addClass('active')
          } else {
            $(el).removeClass('active')
          }
        })

        map.panTo({
          lat: 37.7,
          lng: -122.3
        })

        map.setZoom(10)

        window.scrollTo({ top: 0, behavior: 'smooth' })

        editedFare = null
      })

      $('#timeframe a').on('click', event => {
        event.preventDefault()
        $(event.target).tab('show')

        renderResults()
      })

      $('#edit-fare').click(event => {
        event.preventDefault()
        const userInput = prompt('Enter correct one-way single fare', '2.00')

        if (userInput === undefined) {
          return
        }

        const processedUserInput = parseFloat(userInput.replace(/\$/g, ''))

        if (isNaN(processedUserInput)) {
          return alert('Fare submitted is not a valid number.')
        } else if (processedUserInput <= 0) {
          return alert('Fare submitted is not a positive number.')
        }

        editedFare = processedUserInput

        renderResults()
      })
    })
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKpeuYy5IXMrsQpmwVMpHP_6ymFkqnFbE&libraries=places&callback=initializeMapServices"
    async defer></script>
</body>

</html>
